# SystemVerilog RISC-V Core

## Single Cycle Implementation
Control signals can be found in [CONTROL-SC.md](docs/CONTROL-SC.md).
### Waveform (GTKWave)
[mem/fib.hex](mem/fib.hex):
![](docs/singlecycle-waveform-fib.png)

[mem/testadd.hex](mem/testadd.hex)
![](docs/singlecycle-waveform-testadd.png)

## Multicycle Implementation
Control unit implemented as a FSM (TODO: Diagram)

### Waveform (GTKWave)
[mem/test_rv32i.hex](mem/test_rv32i.hex)
![](docs/multicycle-waveform-testr32i.png)
As can be seen from the waveform, the JAL instruction (assembled `0x00C00A6F`) is located at PC `0x5C`, undergoes states `FETCH` -> `DECODE` -> `JAL` -> `FETCH` ...

During the `JAL` state, `PC+4` is written to register `x20`, as can be verified from the test program [asm/test_rv32i.s](asm/test_rv32i.s).

**Note**: `PC <= PC + 4` assignment is done at the `DECODE` state, due to branching instructions need the *unmodified* PC (i.e. *old* PC without incremented by 4).

## Pipeline Hazard Detection Logic

There are 3 types of hazards in pipelined designs:
- Structural Hazards (hardware resource conflicts)
- Data Hazards (execution has data dependency of previous results in the pipeline)
  - Write after write (WAW)
  - Write after read (WAR)
  - Read after write (RAW)
- Control Hazards (due to jump/branch instruction target prediction)

### Mitigating Hazards
#### Structural Hazards
Structural hazards are already mitigated by the design of RISC-V: It has two separate memory for text and data, dual port register file and exclusive ALU.
#### Data Hazards
**Data Forwarding**: An example of a RAW hazard is:
```s
lui x1, 0x0001
addi x1, x1, 0
```
In `addi`, it should read `x1` that is written by `lui`, but due to pipelining it reads the **old** value:
![raw_hazard](docs/raw_hazard.svg)

To resolve the dependency, we can add a forwarding that forwards the data (generated by the immediate generation unit at the ID stage) from the EX/MEM pipeline register to the input of the EX stage of `addi`.

A visual diagram is like:

![raw_hazard_forward](docs/raw_hazard_forward.svg)

## TODO
1) Add checks for `TEXT_MEM_BEGIN` and `DATA_MEM_BEGIN` memory ranges in `dmem` and `imem`.
